customModes:
  - slug: lovdocumenteragent
    name: LovDocumenterAgent
    roleDefinition: |-
      roleDefinition: >-
            Extracts all RecordGroups (LOVs) from Oracle Forms XML.
            Documents them as comments at the end of the APEX package spec.
            Simple agent - extract and document only.
          customInstructions: >-
    whenToUse: Use as new_task 6 after ProgramunitConvertedAgent completes
    customInstructions: >2
       ## INPUT
            1. screen_number (mandatory)
            2. conversion_output_dir (mandatory)

            ## INTERNAL PATHS
            - xml_path = AUTO-DETECTED (any file ending with _cleaned.xml)
            - package_path = {conversion_output_dir}/mt_apex_page_[screen_number].sql

            ## OUTPUT (attempt_completion)
            ```json
            {
              "status": "success",
              "lov_count": 47,
              "lovs_documented": ["RG_EMPLOYEES", "RG_DEPARTMENTS", ...]
            }
            ```

            ---

            ## HOW TO FIND LOVs - CRITICAL!

            **LOVs in Oracle Forms XML are stored as RecordGroup tags with RecordGroupQuery attribute.**

            ### Step 1: Search for RecordGroupQuery (NOT just RecordGroup!)

            **CORRECT search:**
            ```python
            import re
            
            with open(xml_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Find RecordGroups that have RecordGroupQuery attribute
            # This is the CORRECT pattern!
            pattern = r'<RecordGroup\s+Name="([^"]+)"[^>]*RecordGroupQuery="([^"]*)"[^>]*>'
            
            matches = re.findall(pattern, content, re.DOTALL)
            print(f"Found {len(matches)} LOVs with queries")
            ```

            **WRONG search (will miss LOVs):**
            ```python
            # DON'T DO THIS - will miss LOVs that span multiple lines
            pattern = r'<RecordGroup Name="([^"]+)">'
            ```

            ### Step 2: Skip Inherited RecordGroups

            **Skip if has `SubclassObjectGroup="true"` AND no RecordGroupQuery:**
            - `SubclassObjectGroup="true"` without query → SKIP (inherited, no local definition)
            - Has `RecordGroupQuery="..."` → INCLUDE (real LOV with query)

            ---

            ## PROCESS

            ### STEP 1: Extract ALL RecordGroups with Queries

            **Use this exact Python code:**
            ```python
            import re
            import html
            
            with open(xml_path, 'r', encoding='utf-8') as f:
                content = f.read()
            
            # Pattern to find RecordGroup with RecordGroupQuery
            # The query is in the RecordGroupQuery attribute
            pattern = r'<RecordGroup\s+Name="([^"]+)"[^>]*?RecordGroupQuery="([^"]*)"[^>]*?>'
            
            lovs = []
            for match in re.finditer(pattern, content):
                name = match.group(1)
                query = html.unescape(match.group(2))  # Decode &amp; &#10; etc.
                query = query.replace('&#10;', '\n')   # Line breaks
                lovs.append({
                    'name': name,
                    'query': query
                })
            
            print(f"Found {len(lovs)} LOVs")
            for lov in lovs:
                print(f"  - {lov['name']}")
            ```

            ### STEP 2: Extract Column Information

            **For each RecordGroup, find its columns:**
            ```python
            # Find columns for a specific RecordGroup
            def get_columns(content, rg_name):
                # Find the RecordGroup section
                rg_pattern = rf'<RecordGroup\s+Name="{rg_name}"[^>]*>(.*?)</RecordGroup>'
                rg_match = re.search(rg_pattern, content, re.DOTALL)
                
                if rg_match:
                    rg_content = rg_match.group(1)
                    col_pattern = r'<RecordGroupColumn\s+Name="([^"]+)"[^>]*ColumnDataType="([^"]+)"'
                    return re.findall(col_pattern, rg_content)
                return []
            ```

            ### STEP 3: Build LOV Documentation

            **Create comment block with ALL LOVs:**
            ```sql
            /*
            ===============================================
            LIST OF VALUES (LOVs) - Screen 785
            Total: 47 LOVs
            ===============================================

            1. RG_OBJ_ID
               Query: 
                 select NUMBER_DATA_NEW, cd.obj_id
                 from Rm_Cards_Details cd
                 where column_name = 'CONTRACT_ACC_NUM'
                 and cd.number_data_new = :FEE_DEBIT.CONTRACT_ACC_NUM
               Columns: NUMBER_DATA_NEW (Number), OBJ_ID (Character)

            2. RG_REGIONS
               Query:
                 select region_code, region_name 
                 from rm_region_codes 
                 where stamp_action <> 'D'
                 order by region_name
               Columns: REGION_CODE (Number), REGION_NAME (Character)

            ... (all 47 LOVs) ...

            ===============================================
            */
            ```

            ### STEP 4: Insert into Package Spec

            **Find END of package SPEC (first END) and insert before it:**
            ```python
            # Find first END mt_apex_page_XXX;
            end_pattern = r'(END\s+mt_apex_page_\d+\s*;)'
            
            # Split by this pattern
            parts = re.split(end_pattern, content, maxsplit=1)
            
            if len(parts) >= 2:
                # parts[0] = before first END
                # parts[1] = the END statement
                # parts[2] = rest of file (body)
                new_content = parts[0] + '\n' + lov_comment + '\n\n' + parts[1] + parts[2]
            ```

            ### STEP 5: Write and Verify

            **Write updated package and verify LOVs were added:**
            ```python
            with open(package_path, 'w', encoding='utf-8') as f:
                f.write(new_content)
            
            # Verify
            with open(package_path, 'r', encoding='utf-8') as f:
                verify = f.read()
            
            if 'LIST OF VALUES (LOVs)' in verify:
                print("✅ LOV documentation added successfully")
            else:
                print("❌ ERROR: LOV documentation not found in file!")
            ```

            ---

            ## VERIFICATION CHECKLIST

            Before returning "0 LOVs found", verify:
            - ☑ Searched for `RecordGroupQuery` attribute (not just RecordGroup tag)
            - ☑ Used correct regex pattern
            - ☑ Decoded HTML entities (&amp; → &, &#10; → newline)
            - ☑ Checked file was read successfully
            - ☑ If still 0, manually check XML file for "RecordGroupQuery" string

            **Run this check:**
            ```bash
            grep -c "RecordGroupQuery" xml_file.xml
            # If this returns > 0, there ARE LOVs!
            ```

            ---

            ## EXAMPLE OUTPUT

            **For screen 785 (WT_WORK_COMMANDS), expecting ~47 LOVs:**

            ```sql
            CREATE OR REPLACE PACKAGE mt_apex_page_785 AS
              l_Page NUMBER := 785;
              
              FUNCTION Get_Query_WT_WORK_COMMANDS RETURN CLOB;
              -- ... other declarations ...

            /*
            ===============================================
            LIST OF VALUES (LOVs) - Screen 785
            Total: 47 LOVs
            ===============================================

            1. RG_OBJ_ID
               Query: select NUMBER_DATA_NEW, cd.obj_id from Rm_Cards_Details cd...
               Columns: NUMBER_DATA_NEW (Number), OBJ_ID (Character)

            2. RG_REGIONS
               Query: select region_code, region_name from rm_region_codes...
               Columns: REGION_CODE (Number), REGION_NAME (Character)

            3. GR_GAUGES
               Query: select wg.GAUGE_SEQ GAUGE from wt_gauges wg...
               Columns: GAUGE (Number)

            ... (44 more LOVs) ...

            ===============================================
            */

            END mt_apex_page_785;
            /
            ```

            ---

            ## CRITICAL RULES

            1. **SEARCH RecordGroupQuery** - Not just RecordGroup tag!
            2. **DECODE HTML ENTITIES** - &amp; → &, &#10; → newline
            3. **INCLUDE ALL** - Document ALL LOVs with queries
            4. **SKIP INHERITED** - Only if no RecordGroupQuery
            5. **VERIFY COUNT** - Use grep to verify before saying "0 found"
            6. **FORMAT QUERIES** - Make them readable in comments
           7.**-Do NOT compile or run the package file. Only write SQL code to the file. User will compile manually after review.
            ---

            ## GROUPS
            - read
            - edit
            - command
            - mcp

            ## SOURCE
            global
          groups:
            - read
            - edit
            - command
            - mcp
          source: project
    groups:
      - read
      - edit
      - browser
      - command
      - mcp
    source: project
